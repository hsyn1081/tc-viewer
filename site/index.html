<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>DGN ENGINEERING – TC Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- Basit engeller -->
  <script>
    addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
    addEventListener('keydown', e => {
      const k=(e.key||'').toUpperCase(), cmd=e.ctrlKey||e.metaKey;
      if (k==='F12'||e.keyCode===123) { e.preventDefault(); e.stopPropagation(); return false; }
      if (cmd && e.shiftKey && ['I','J','C','K'].includes(k)) { e.preventDefault(); e.stopPropagation(); return false; }
      if (cmd && ['U','S','P'].includes(k)) { e.preventDefault(); e.stopPropagation(); return false; }
    }, {capture:true});
  </script>

  <style>
    :root{ --bg:#0f172a; --bg2:#0b1220; --text:#e5e7eb; --muted:#94a3b8; }
    html,body{height:100%;margin:0;background:var(--bg2);color:var(--text);font:14px system-ui,Segoe UI,Roboto,Inter,sans-serif}
    #wrap{height:100%;display:flex;flex-direction:column}
    #topbar{height:56px;display:flex;align-items:center;gap:14px;padding:8px 14px;background:#0f172a;border-bottom:1px solid #1f2937}
    #brand{display:flex;align-items:center;gap:10px;min-width:240px}
    #brand img{height:28px}
    #brand .name{letter-spacing:.12em;font-weight:700}
    #status{padding:4px 8px;border-radius:999px;background:#1f2937;color:#cbd5e1;font-size:12px}
    #spacer{flex:1}
    #logline{color:#a5b4fc;font:12px ui-monospace,Menlo,Consolas,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #viewerWrap{position:relative;flex:1;min-height:0}
    #tc{position:absolute;inset:0;width:100%;height:100%;border:0;background:#0b1220}
  </style>
</head>
<body>
<div id="wrap">
  <header id="topbar">
    <div id="brand">
      <img src="https://www.dgnengineering.com/wp-content/uploads/2020/06/dsn-logo-renkli.png" alt="DGN">
      <div class="name">DGN ENGINEERING</div>
    </div>
    <div id="status">Başlatılıyor…</div>
    <div id="spacer"></div>
    <div id="logline" title="Son log"></div>
  </header>

  <div id="viewerWrap">
    <iframe id="tc" title="Trimble Connect Viewer"></iframe>
  </div>
</div>

<script>
(async () => {
  // -------- helpers --------
  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const loglineEl = $('#logline');
  const setStatus = t => statusEl.textContent = t;
  const log = (...a) => { const m=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); console.log('[TC]',...a); loglineEl.textContent=m; };
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const steel = 'rgb(112,128,144)';

  const u = new URL(location.href);
  const debug = u.searchParams.get('debug') === '1';

  // POS sadece URL'den
  function readPos() {
    const qPos = u.searchParams.get('pos');
    if (qPos && qPos.trim()) return decodeURIComponent(qPos.trim());
    const h=(location.hash||'').replace(/^#/, '');
    if (h && h.trim()) return decodeURIComponent(h.trim());
    return '';
  }
  function writePosToUrl(pos){
    const base = location.pathname + location.search;
    history.replaceState(null,'',base + '#' + encodeURIComponent(pos));
  }

  // ---- 1) URL’den gelen projectId, modelId, stoken'ı al; /config ile doğrulat ----
  const pid = u.searchParams.get('projectId') || '';
  const mid = u.searchParams.get('modelId')   || '';
  const tok = u.searchParams.get('stoken')    || '';
  if (!pid || !mid || !tok) { setStatus('Eksik URL parametresi'); log('missing url params'); return; }

  setStatus('Sunucudan doğrulama…');
  let cfg;
  try {
    const qs = new URLSearchParams({ projectId: pid, modelId: mid, stoken: tok });
    const r = await fetch('/config?' + qs.toString(), { method: 'GET' });
    if (!r.ok) throw new Error('config ' + r.status);
    cfg = await r.json();
  } catch (e) { setStatus('Config alınamadı'); log('config error:', e.message || e); return; }

  // ---- 2) Viewer aç ----
  const { getConnectEmbedUrl, connect } = TrimbleConnectWorkspace;
  const iframe = $('#tc');
  iframe.src = getConnectEmbedUrl('prod');

  let suppressSelectionHandler = false;
  let currentSearchId = 0;

  const ws = await connect(iframe, (evt) => {
    if (debug) log('evt:', evt);
    if (evt === 'viewer.onSelectionChanged' && !suppressSelectionHandler) {
      handleUserPick().catch(e => log('pick handler error', e.message || e));
    }
  });
  if (debug) window.ws = ws;

  await ws.embed.setTokens({ shareToken: cfg.stoken });
  await ws.embed.init3DViewer({ projectId: cfg.projectId, modelId: cfg.modelId });

  setStatus('Viewer hazır');

  // ---- seçim & izolasyon yardımcıları ----
  const toNum = x => Number(x);
  const ASM_KEYS = [
    'Tekla Assembly.Assembly/Cast unit Mark',
    'Default.ASSEMBLY_POS',
    'Tekla Common.Assembly Position',
    'AISC_EM11_Pset_AssemblyIdentification.AssemblyMark'
  ];
  const PART_KEYS_FALLBACK = [
    'Default.ASSEMBLY_POS','Tekla Common.Assembly Position','Tekla Assembly.Assembly/Cast unit Mark','AISC_EM11_Pset_AssemblyIdentification.AssemblyMark'
  ];

  // Tıklanınca yazılacak "Reference" anahtarları (iki varyant)
  const REF_KEYS = [
    'Pset_BeamCommon.Reference',
    'Pset_ColumnCommon.Reference',
    'Pset_PlateCommon.Reference',
    'Pset_MemberCommon.Reference',
    'AISC_EM11_Pset_PieceIdentification.IndicationMark'
  ];

  function flattenHierarchy(arr, out=[], defMid){
    for (const n of (arr||[])) {
      const mid = n.fileId || defMid;
      if (typeof n?.id === 'number') out.push({ modelId: mid, rid: Number(n.id) });
      if (n?.children?.length) flattenHierarchy(n.children, out, mid);
    }
    return out;
  }
  async function getSelectionPairs(){
    const sets = await ws.viewer.getSelection();
    return sets.flatMap(s => (s.objectRuntimeIds||[]).map(rid => ({ modelId:s.modelId, rid:toNum(rid) })));
  }
  async function isolateChosenAndParts(chosen, childPairs){
    const all = [{ modelId: chosen.modelId, rid: chosen.rid }, ...childPairs];
    const byModel = new Map();
    for (const {modelId,rid} of all){ if(!byModel.has(modelId)) byModel.set(modelId,new Set()); byModel.get(modelId).add(Number(rid)); }
    const payload = [...byModel.entries()].map(([mid,set]) => ({ modelId: mid, entityIds: [...set] }));
    await ws.viewer.isolateEntities(payload);
  }
  async function colorParts(pairs, colorCss){
    if(!pairs.length) return;
    const byModel = pairs.reduce((m,{modelId,rid}) => ((m[modelId]??=[]).push(rid),m),{});
    const mo = Object.entries(byModel).map(([mid,rids]) => ({ modelId: mid, objectRuntimeIds: rids }));
    await ws.viewer.setObjectState({ modelObjectIds: mo }, { color: colorCss, opacity:1, visible:true });
  }

  // ---- Markup yardımcıları ----
  async function removeAllTextMarkups(){
    try {
      const list = await ws.markup.getTextMarkups().catch(()=>[]);
      if (list?.length) await ws.markup.removeMarkups(list.map(m => m.id));
    } catch {}
  }
  async function handleUserPick(){
    const sets = await ws.viewer.getSelection();
    const total = sets.reduce((n,s)=>n+(s.objectRuntimeIds?.length||0),0);
    if (total !== 1) return;

    // önce tüm eski text markupları kaldır
    await removeAllTextMarkups();

    const mid = sets[0].modelId;
    const rid = Number(sets[0].objectRuntimeIds[0]);

    // Reference değerini bul
    let refText = null;
    try {
      const [p] = await ws.viewer.getObjectProperties(mid, [rid]);
      const flat = new Map(
        (p?.properties || []).flatMap(ps =>
          (ps.properties || []).map(pr => [`${ps.name}.${pr.name}`, pr.value]))
      );
      for (const k of REF_KEYS) {
        const v = flat.get(k);
        if (v != null && String(v).trim() !== '') { refText = String(v); break; }
      }
    } catch {}

    if (!refText) { setStatus('Reference bulunamadı'); return; }

    // Parça konumu (metre → mm)
    const pts = await ws.viewer.getObjectPositions(mid, [rid]).catch(()=>[]);
    const pos = pts?.[0]?.position || pts?.[0];
    if (!pos || typeof pos.x !== 'number') { setStatus('Pozisyon okunamadı'); return; }

    const x = pos.x*1000, y = pos.y*1000, z = pos.z*1000;
    const start = { positionX:x, positionY:y, positionZ:z };
    const end   = { positionX:x, positionY:y, positionZ:z + 200 };

    try {
      await ws.markup.addTextMarkup([{ start, end, text: refText, color:{ r:.95, g:.95, b:.95, a:1 } }]);
      setStatus(`Markup eklendi: ${refText}`);
    } catch (e) { setStatus(`Markup hatası`); }
  }

  // ---- Tek denemelik seçim ----
  async function trySelectByPosOnce(pos){
    const raw=(pos||'').trim();
    const vars=[raw, raw.replace('/',''), raw.replace('/',' '), raw.replace('/','-')];
    for (const key of ASM_KEYS){
      for (const val of vars){
        try{
          await ws.viewer.setSelection({ parameter:{ properties:{ [key]:[val] } } }, 'set');
          await new Promise(r=>setTimeout(r,150));
          const pairs = await getSelectionPairs();
          if (pairs.length) return { key, val, pairs, via:'setSelection' };
        }catch{}
        try{
          const sets = await ws.viewer.getObjects({ parameter:{ properties:{ [key]:[val] } } }).catch(()=>[]);
          const count = (sets||[]).reduce((n,s)=>n+(s.objectRuntimeIds?.length||0),0);
          if (count>0){
            const first = sets[0];
            const rid = Number(first.objectRuntimeIds[0]);
            return { key, val, pairs:[{ modelId:first.modelId, rid }], via:'getObjects' };
          }
        }catch{}
      }
    }
    return null;
  }

  // ---- Eşleşene kadar ara ----
  const SEARCH_INTERVAL_MS = 900;
  async function runForPos(pos){
    if(!pos){ setStatus('URL’den poz yok'); return; }
    writePosToUrl(pos);
    setStatus('Aranıyor…');
    suppressSelectionHandler = true;   // arama sürecinde tık handler devre dışı
    let tries=0;
    while(true){
      tries++;
      const hit = await trySelectByPosOnce(pos);
      if (hit){
        const chosen = hit.pairs[0];
        const chosenMO = [{ modelId: chosen.modelId, objectRuntimeIds:[chosen.rid] }];

        let nodes=[];
        try{ nodes = await ws.viewer.getHierarchyChildren(chosen.modelId,[chosen.rid],'assembly',true);}catch{}
        if(!nodes?.length){ try{ nodes = await ws.viewer.getHierarchyChildren(chosen.modelId,[chosen.rid],undefined,true);}catch{} }
        let childPairs = flattenHierarchy(nodes, [], chosen.modelId);

        if(!childPairs.length){
          const bag = new Map();
          for (const k of PART_KEYS_FALLBACK){
            const s2 = await ws.viewer.getObjects({ parameter:{ properties:{ [k]:[pos] } } }).catch(()=>[]);
            for (const s of (s2||[])){
              const set = bag.get(s.modelId)||new Set();
              (s.objectRuntimeIds||[]).forEach(r=>set.add(Number(r)));
              bag.set(s.modelId,set);
            }
          }
          childPairs = [...bag.entries()].flatMap(([mid,set]) => [...set].map(rid => ({ modelId: mid, rid })));
        }

        await ws.viewer.setSelection({ modelObjectIds: chosenMO }, 'set');
        await isolateChosenAndParts(chosen, childPairs);
        await colorParts(childPairs, steel);
        await ws.viewer.setObjectState({ modelObjectIds: chosenMO }, { visible:true, color:steel, opacity:1 });
        try{ await ws.viewer.setCamera({ modelObjectIds: chosenMO }, { animationTime:0.8 }); }catch{}
        setStatus(`Bulundu: ${hit.key}="${hit.val}", parça: ${childPairs.length}`);
        suppressSelectionHandler = false; // kullanıcı tıklamaları artık markup üretsin
        return;
      }
      setStatus(`Aranıyor… (${tries}. deneme)`);
      await sleep(SEARCH_INTERVAL_MS);
    }
  }

  await sleep(600);
  await runForPos(readPos());
  addEventListener('hashchange', () => runForPos(readPos()));
})();
</script>
</body>
</html>
